name: build-and-test-in-docker
run-name: ${{ github.actor }} builds and tests RGL in docker
on: [workflow_dispatch, push]
jobs:
#   build-docker:
#     runs-on: self-hosted
#     steps:
#       - name: Check out repository code
#         uses: actions/checkout@v3
#       - run: docker build . --tag rgl:latest
  test-in-docker:
#       needs: build-docker
      runs-on: self-hosted
      steps:
        - name: start docker
          run: docker run
             --detach
             --name rgl
             --net=host 
             --gpus all 
             -v $(pwd):/code
             -v ${OptiX_INSTALL_DIR}:/optix
             -e OptiX_INSTALL_DIR=/optix
             -e NVIDIA_DRIVER_CAPABILITIES=all
             rgl:latest
        - name: build RGL inside docker
          run: docker exec rgl sh -c "./setup.py --clean-build --with-pcl"
        - name: run tests
          run: docker exec rgl sh -c "./build/test/RobotecGPULidar_test"
        - name: remove docker container
          run: docker rm rgl
