name: build-and-test-in-docker
run-name: ${{ github.actor }} builds and tests RGL in docker
on: workflow_dispatch
jobs:
  checkout-repository:
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      
  build-docker-if-no-image:
    needs: checkout-repository
    runs-on: self-hosted
    steps:
      - run: |
             if [[ "$(docker images -q rgl:with-ros2 2> /dev/null)" == "" ]]
             then
               docker build . --tag rgl:with-ros2 --target with-ros2
             fi

  test-in-docker:
      needs: build-docker-if-no-image
      runs-on: self-hosted
      steps:
        - name: compile and test RGL in docker
          run: |
               docker run \
               --rm \
               --name rgl \
               --net=host \
               --gpus all \
               -v $(pwd):/code \
               -v ${OptiX_INSTALL_DIR}:/optix \
               -e OptiX_INSTALL_DIR=/optix \
               -e NVIDIA_DRIVER_CAPABILITIES=all \
               rgl:with-ros2 \
               sh -c "
               . /opt/ros/humble/setup.bash && \
               ./setup.py --with-ros2-standalone && \
               mv ./ros2_standalone/* ./build/ && \
               ./build/test/RobotecGPULidar_test && \
               rm -r build"
