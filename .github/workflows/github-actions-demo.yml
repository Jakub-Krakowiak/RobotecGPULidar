name: build-and-test-in-docker
run-name: ${{ github.actor }} builds and tests RGL in docker
on: [workflow_dispatch, push]
jobs:
#   build-docker:
#     runs-on: self-hosted
#     steps:
#       - name: Check out repository code
#         uses: actions/checkout@v3
#       - run: docker build . --tag rgl:latest
  test-in-docker:
#       needs: build-docker
      runs-on: self-hosted
      steps:
        - name: compile and test RGL in docker
          run: |
               docker run \
               --net=host \
               --gpus all \
               -v $(pwd):/code \
               -v ${OptiX_INSTALL_DIR}:/optix \
               -e OptiX_INSTALL_DIR=/optix \
               -e NVIDIA_DRIVER_CAPABILITIES=all \
               rgl:latest \
               sh -c "./setup.py --clean-build && ./build/test/RobotecGPULidar_test"
  remove-build-files:
    needs: test-in-docker
    runs-on: self-hosted
    steps:
      - name: remove build directory
        run: sudo rm -rf build
